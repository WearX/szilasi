<!doctype html>
<html lang="hu">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Auth Screen -->
  <div id="authScreen" class="auth-container">
    <div class="auth-card">
      <h1>Bel√©p√©s</h1>
      <div class="input-group">
        <label for="email">Email c√≠m</label>
        <input id="email" type="email" placeholder="pelda@email.com" />
      </div>
      <div class="input-group">
        <label for="password">Jelsz√≥</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="btn btn-primary" onclick="auth('signin')">Bel√©p√©s</button>
      <button class="btn btn-secondary" onclick="auth('signup')">√öj fi√≥k l√©trehoz√°sa</button>
    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chatScreen" class="chat-container hidden">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="user-avatar" id="userAvatar" onclick="showProfileModal()" style="cursor: pointer;">?</div>
        <div class="user-info">
          <h2 id="userName">Felhaszn√°l√≥</h2>
          <span id="userStatus">Online</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-icon" onclick="showProfileModal()" title="Profil be√°ll√≠t√°sok">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </button>
        <button class="btn-logout" onclick="location.reload()">Kijelentkez√©s</button>
      </div>
    </div>

    <div class="chat-selector">
      <select id="targetSelect" onchange="render()">
        <option value="">Publikus cseveg√©s</option>
      </select>
      <button class="btn-new-group" onclick="showGroupModal()">√öj csoport</button>
    </div>

    <div class="messages-container" id="messages">
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <span>M√©g nincsenek √ºzenetek</span>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <input id="msgInput" placeholder="√çrj √ºzenetet..." onkeypress="if(event.key==='Enter')send()" />
        <button class="btn-send" onclick="send()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Group Modal -->
  <div id="groupModal" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal">
      <h3>√öj csoport l√©trehoz√°sa</h3>
      <input id="newGroupName" type="text" placeholder="Csoport neve" />
      <div class="user-list" id="userListCheckboxes">
        <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">
          Nincs el√©rhet≈ë felhaszn√°l√≥
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="document.getElementById('groupModal').classList.add('hidden')">M√©gse</button>
        <button class="btn btn-primary" onclick="createGroup()">L√©trehoz√°s</button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal profile-modal">
      <h3>Profil be√°ll√≠t√°sok</h3>

      <!-- Avatar Section -->
      <div class="profile-section">
        <h4>Profilk√©p</h4>
        <div class="avatar-preview">
          <div class="large-avatar" id="profileAvatar">?</div>
        </div>
        <div id="avatarDropZone" class="drop-zone" onclick="document.getElementById('avatarInput').click()">
          <input type="file" id="avatarInput" accept="image/png,image/jpg,image/jpeg" style="display: none;" onchange="uploadAvatar()" />
          <div class="drop-zone-content">
            <svg viewBox="0 0 24 24" width="32" height="32" style="fill: #999; margin-bottom: 8px;">
              <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span>Kattints vagy h√∫zd ide a k√©pet</span>
          </div>
        </div>
        <div id="avatarStatus" class="upload-status"></div>
        <p class="hint">PNG, JPG vagy JPEG, max 5MB</p>
      </div>

      <!-- File Upload Section -->
      <div class="profile-section">
        <h4>F√°jlok felt√∂lt√©se</h4>
        <div id="fileDropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect()" />
          <div class="drop-zone-content">
            <svg viewBox="0 0 24 24" width="32" height="32" style="fill: #999; margin-bottom: 8px;">
              <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
            </svg>
            <span>Kattints vagy h√∫zd ide a f√°jlokat</span>
          </div>
        </div>
        <div id="selectedFiles" class="selected-files-list"></div>
        <div id="fileUploadStatus" class="upload-status"></div>
        <button id="uploadFilesBtn" class="btn btn-primary" onclick="uploadFiles()" style="display: none; margin-top: 12px;">
          F√°jlok felt√∂lt√©se
        </button>
        <p class="hint">Max 10 f√°jl, egyenk√©nt max 5MB</p>
      </div>

      <!-- Uploaded Files List -->
      <div class="profile-section">
        <h4>Felt√∂lt√∂tt f√°jlok</h4>
        <div id="filesList" class="files-list">
          <div class="loading">Bet√∂lt√©s...</div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="document.getElementById('profileModal').classList.add('hidden')">Bez√°r√°s</button>
      </div>
    </div>
  </div>

  <script>
    let socket, token, myEmail, messages = [], activeUsers = [], myGroups = [];

    async function auth(type) {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      
      if (!email || !pass) {
        alert("K√©rlek t√∂ltsd ki mindk√©t mez≈ët!");
        return;
      }
      
      const res = await fetch(`http://localhost:3000/user/${type}`, {
        method: "POST", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: pass })
      });
      
      const data = await res.json();
      
      if (data.token) {
        token = data.token; 
        myEmail = email;
        
        document.getElementById("authScreen").classList.add("hidden");
        document.getElementById("chatScreen").classList.remove("hidden");
        document.getElementById("userName").innerText = email.split('@')[0];
        document.getElementById("userAvatar").innerText = email.charAt(0).toUpperCase();

        loadData();
        connectWs();
      } else {
        alert(data.error || "Hiba t√∂rt√©nt!");
      }
    }

    async function loadData() {
      const msgRes = await fetch("http://localhost:3000/messages", { 
        headers: { "x-access-token": token } 
      });
      messages = await msgRes.json();
      await loadGroups();
      render();
    }

    async function loadGroups() {
      const grpRes = await fetch("http://localhost:3000/groups", { 
        headers: { "x-access-token": token } 
      });
      myGroups = await grpRes.json();
      renderSelect();
    }

    function connectWs() {
      socket = new WebSocket(`ws://localhost:8080?token=${token}`);

      socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === "users") {
          activeUsers = data.users;
          renderSelect();
        }
        else if (data.type === "updateGroups") {
          loadGroups();
        }
        else {
          messages.push(data);
          render();
        }
      };
    }

    function renderSelect() {
      const sel = document.getElementById("targetSelect");
      const current = sel.value;
      
      sel.innerHTML = '<option value="">Publikus cseveg√©s</option>';
      
      if (myGroups.length > 0) {
        sel.innerHTML += '<optgroup label="Csoportok">';
        myGroups.forEach(g => sel.innerHTML += `<option value="GRP_${g.id}">${g.name}</option>`);
        sel.innerHTML += '</optgroup>';
      }
      
      const otherUsers = activeUsers.filter(u => u !== myEmail);
      if (otherUsers.length > 0) {
        sel.innerHTML += '<optgroup label="Priv√°t √ºzenetek">';
        otherUsers.forEach(u => sel.innerHTML += `<option value="${u}">${u.split('@')[0]}</option>`);
        sel.innerHTML += '</optgroup>';
      }
      
      sel.value = current;
    }

    function render() {
      const target = document.getElementById("targetSelect").value;
      const box = document.getElementById("messages");

      const filteredMessages = messages.filter(m => {
        if (target.startsWith("GRP_")) {
          const grpId = parseInt(target.split("_")[1]);
          return m.groupId === grpId;
        }

        if (target) {
          return !m.groupId && (
            (m.senderEmail === target && m.receiverEmail === myEmail) ||
            (m.senderEmail === myEmail && m.receiverEmail === target)
          );
        }

        return !m.groupId && !m.receiverEmail;
      });

      if (filteredMessages.length === 0) {
        box.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <span>M√©g nincsenek √ºzenetek</span>
          </div>
        `;
        return;
      }

      box.innerHTML = "";
      
      filteredMessages.forEach(m => {
        const isMe = m.senderEmail === myEmail;
        const senderName = isMe ? "Te" : m.senderEmail.split('@')[0];
        const msgClass = isMe ? "sent" : "received";

        box.innerHTML += `
          <div class="message ${msgClass}">
            <span class="message-sender">${senderName}</span>
            <div class="message-bubble">${escapeHtml(m.message)}</div>
          </div>
        `;
      });

      box.scrollTop = box.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function send() {
      const input = document.getElementById("msgInput");
      const msg = input.value.trim();
      const target = document.getElementById("targetSelect").value;
      
      if (!msg) return;

      let payload = { message: msg };
      if (target.startsWith("GRP_")) payload.groupId = parseInt(target.split("_")[1]);
      else if (target) payload.targetEmail = target;

      await fetch("http://localhost:3000/messages", {
        method: "POST", 
        headers: { "Content-Type": "application/json", "x-access-token": token },
        body: JSON.stringify(payload)
      });

      socket.send(JSON.stringify(payload));
      input.value = "";
    }

    function showGroupModal() {
      document.getElementById("groupModal").classList.remove("hidden");
      document.getElementById("newGroupName").value = "";
      
      const list = document.getElementById("userListCheckboxes");
      const otherUsers = activeUsers.filter(u => u !== myEmail);
      
      if (otherUsers.length === 0) {
        list.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">
            Nincs el√©rhet≈ë felhaszn√°l√≥
          </div>
        `;
        return;
      }
      
      list.innerHTML = "";
      otherUsers.forEach((u, i) => {
        list.innerHTML += `
          <div class="user-list-item">
            <input type="checkbox" id="user_${i}" value="${u}">
            <label for="user_${i}">${u.split('@')[0]}</label>
          </div>
        `;
      });
    }

    async function createGroup() {
      const name = document.getElementById("newGroupName").value.trim();
      const checks = document.querySelectorAll("#userListCheckboxes input:checked");
      const members = Array.from(checks).map(c => c.value);

      if (!name) {
        alert("Add meg a csoport nev√©t!");
        return;
      }

      if (members.length === 0) {
        alert("V√°lassz legal√°bb egy tagot!");
        return;
      }

      const res = await fetch("http://localhost:3000/groups", {
        method: "POST", 
        headers: { "Content-Type": "application/json", "x-access-token": token },
        body: JSON.stringify({ name, members })
      });

      if (res.ok) {
        document.getElementById("groupModal").classList.add("hidden");

        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "newGroup", members: members }));
        }

        loadGroups();
      } else {
        const err = await res.json();
        alert(err.error);
      }
    }

    // Profile Modal Functions
    let selectedFiles = [];
    let currentAvatarUrl = null;
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const MAX_FILES = 10;

    async function showProfileModal() {
      document.getElementById("profileModal").classList.remove("hidden");
      updateAvatarDisplay();
      initDropZones();
      await loadFilesList();
    }

    function initDropZones() {
      const avatarZone = document.getElementById("avatarDropZone");
      const fileZone = document.getElementById("fileDropZone");

      [avatarZone, fileZone].forEach(zone => {
        zone.ondragover = (e) => { e.preventDefault(); zone.classList.add("drag-over"); };
        zone.ondragleave = () => zone.classList.remove("drag-over");
      });

      avatarZone.ondrop = (e) => {
        e.preventDefault();
        avatarZone.classList.remove("drag-over");
        const file = e.dataTransfer.files[0];
        if (file) {
          document.getElementById("avatarInput").files = e.dataTransfer.files;
          uploadAvatar();
        }
      };

      fileZone.ondrop = (e) => {
        e.preventDefault();
        fileZone.classList.remove("drag-over");
        addFilesToSelection(Array.from(e.dataTransfer.files));
      };
    }

    function updateAvatarDisplay() {
      const avatarEl = document.getElementById("profileAvatar");
      const headerAvatar = document.getElementById("userAvatar");

      if (currentAvatarUrl) {
        avatarEl.innerHTML = `<img src="${currentAvatarUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
        headerAvatar.innerHTML = `<img src="${currentAvatarUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      } else {
        const letter = myEmail ? myEmail.charAt(0).toUpperCase() : '?';
        avatarEl.textContent = letter;
        headerAvatar.textContent = letter;
      }
    }

    function showStatus(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="${isError ? 'status-error' : 'status-success'}">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 3000);
    }

    async function loadFilesList() {
      const listEl = document.getElementById("filesList");
      listEl.innerHTML = '<div class="loading"><div class="spinner"></div> Bet√∂lt√©s...</div>';

      try {
        const res = await fetch("http://localhost:3000/files", {
          headers: { "x-access-token": token }
        });

        if (!res.ok) {
          listEl.innerHTML = '<div class="empty-files">Nincsenek felt√∂lt√∂tt f√°jlok</div>';
          return;
        }

        const files = await res.json();

        if (files.length === 0) {
          listEl.innerHTML = '<div class="empty-files">Nincsenek felt√∂lt√∂tt f√°jlok</div>';
          return;
        }

        listEl.innerHTML = files.map(file => `
          <div class="file-item">
            <span class="file-icon">${getFileIcon(file.name)}</span>
            <span class="file-name">${escapeHtml(file.name)}</span>
            <button class="btn-download" onclick="downloadFile('${file.url}', '${escapeHtml(file.name)}')">
              Let√∂lt√©s
            </button>
          </div>
        `).join('');

      } catch (err) {
        console.error(err);
        listEl.innerHTML = '<div class="empty-files">Hiba t√∂rt√©nt a f√°jlok bet√∂lt√©sekor</div>';
      }
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = { pdf:'üìÑ', doc:'üìù', docx:'üìù', xls:'üìä', xlsx:'üìä', png:'üñºÔ∏è', jpg:'üñºÔ∏è', jpeg:'üñºÔ∏è', gif:'üñºÔ∏è', mp4:'üé¨', mp3:'üéµ', zip:'üì¶', rar:'üì¶' };
      return icons[ext] || 'üìé';
    }

    async function downloadFile(url, filename) {
      try {
        const res = await fetch(url, { headers: { "x-access-token": token } });
        if (!res.ok) throw new Error('Let√∂lt√©s sikertelen');
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      } catch (err) {
        alert('Let√∂lt√©s sikertelen: ' + err.message);
      }
    }

    async function uploadAvatar() {
      const input = document.getElementById("avatarInput");
      const file = input.files[0];
      if (!file) return;

      if (!['image/png', 'image/jpg', 'image/jpeg'].includes(file.type)) {
        showStatus("avatarStatus", "Csak PNG, JPG vagy JPEG!", true);
        return;
      }

      if (file.size > MAX_FILE_SIZE) {
        showStatus("avatarStatus", "Max 5MB m√©ret!", true);
        return;
      }

      const avatarEl = document.getElementById("profileAvatar");
      avatarEl.innerHTML = '<div class="spinner"></div>';

      const formData = new FormData();
      formData.append("avatar", file);

      try {
        const res = await fetch("http://localhost:3000/user/avatar", {
          method: "PUT",
          headers: { "x-access-token": token },
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          // Show preview immediately
          const reader = new FileReader();
          reader.onload = (e) => {
            currentAvatarUrl = e.target.result;
            updateAvatarDisplay();
          };
          reader.readAsDataURL(file);

          showStatus("avatarStatus", "Profilk√©p felt√∂ltve!");
          await loadFilesList();
        } else {
          showStatus("avatarStatus", data.error || "Hiba!", true);
          updateAvatarDisplay();
        }
      } catch (err) {
        showStatus("avatarStatus", "Hiba t√∂rt√©nt!", true);
        updateAvatarDisplay();
      }

      input.value = "";
    }

    function handleFileSelect() {
      const input = document.getElementById("fileInput");
      addFilesToSelection(Array.from(input.files));
      input.value = "";
    }

    function addFilesToSelection(files) {
      const validFiles = files.filter(file => {
        if (file.size > MAX_FILE_SIZE) {
          showStatus("fileUploadStatus", `${file.name} t√∫l nagy (max 5MB)`, true);
          return false;
        }
        return true;
      });

      selectedFiles = [...selectedFiles, ...validFiles].slice(0, MAX_FILES);
      renderSelectedFiles();
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderSelectedFiles();
    }

    function renderSelectedFiles() {
      const container = document.getElementById("selectedFiles");
      const uploadBtn = document.getElementById("uploadFilesBtn");

      if (selectedFiles.length === 0) {
        container.innerHTML = '';
        uploadBtn.style.display = 'none';
        return;
      }

      uploadBtn.style.display = 'block';
      container.innerHTML = selectedFiles.map((file, i) => `
        <div class="selected-file-item">
          <span class="file-icon">${getFileIcon(file.name)}</span>
          <div class="file-info">
            <span class="file-name">${escapeHtml(file.name)}</span>
            <span class="file-size">${formatSize(file.size)}</span>
          </div>
          <button class="btn-remove" onclick="removeFile(${i})">√ó</button>
        </div>
      `).join('');
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function uploadFiles() {
      if (selectedFiles.length === 0) return;

      const uploadBtn = document.getElementById("uploadFilesBtn");
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<div class="spinner-small"></div> Felt√∂lt√©s...';

      const formData = new FormData();
      selectedFiles.forEach(file => formData.append("files", file));

      try {
        const res = await fetch("http://localhost:3000/files/upload", {
          method: "POST",
          headers: { "x-access-token": token },
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          showStatus("fileUploadStatus", `${selectedFiles.length} f√°jl felt√∂ltve!`);
          selectedFiles = [];
          renderSelectedFiles();
          await loadFilesList();
        } else {
          showStatus("fileUploadStatus", data.error || "Hiba!", true);
        }
      } catch (err) {
        showStatus("fileUploadStatus", "Hiba t√∂rt√©nt!", true);
      }

      uploadBtn.disabled = false;
      uploadBtn.textContent = 'F√°jlok felt√∂lt√©se';
    }
  </script>
</body>

</html>