<!doctype html>
<html lang="hu">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Auth Screen -->
  <div id="authScreen" class="auth-container">
    <div class="auth-card">
      <h1>Bel√©p√©s</h1>
      <div class="input-group">
        <label for="email">Email c√≠m</label>
        <input id="email" type="email" placeholder="pelda@email.com" />
      </div>
      <div class="input-group">
        <label for="password">Jelsz√≥</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="btn btn-primary" onclick="auth('signin')">Bel√©p√©s</button>
      <button class="btn btn-secondary" onclick="auth('signup')">√öj fi√≥k l√©trehoz√°sa</button>
    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chatScreen" class="chat-container hidden">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="user-avatar" id="userAvatar" onclick="showProfileModal()" style="cursor: pointer;">?</div>
        <div class="user-info">
          <h2 id="userName">Felhaszn√°l√≥</h2>
          <span id="userStatus">Online</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-icon" onclick="showProfileModal()" title="Profil be√°ll√≠t√°sok">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </button>
        <button class="btn-logout" onclick="location.reload()">Kijelentkez√©s</button>
      </div>
    </div>

    <div class="chat-selector">
      <select id="targetSelect" onchange="render()">
        <option value="">Publikus cseveg√©s</option>
      </select>
      <button class="btn-new-group" onclick="showGroupModal()">√öj csoport</button>
    </div>

    <div class="messages-container" id="messages">
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <span>M√©g nincsenek √ºzenetek</span>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <input id="msgInput" placeholder="√çrj √ºzenetet..." onkeypress="if(event.key==='Enter')send()" />
        <button class="btn-send" onclick="send()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Group Modal -->
  <div id="groupModal" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal">
      <h3>√öj csoport l√©trehoz√°sa</h3>
      <input id="newGroupName" type="text" placeholder="Csoport neve" />
      <div class="user-list" id="userListCheckboxes">
        <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">
          Nincs el√©rhet≈ë felhaszn√°l√≥
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="document.getElementById('groupModal').classList.add('hidden')">M√©gse</button>
        <button class="btn btn-primary" onclick="createGroup()">L√©trehoz√°s</button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal profile-modal">
      <h3>Profil be√°ll√≠t√°sok</h3>
      
      <!-- Avatar Section -->
      <div class="profile-section">
        <h4>Profilk√©p</h4>
        <div class="avatar-preview">
          <div class="large-avatar" id="profileAvatar">?</div>
        </div>
        <input type="file" id="avatarInput" accept="image/png,image/jpg,image/jpeg" style="display: none;" onchange="uploadAvatar()" />
        <button class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
          <svg viewBox="0 0 24 24" width="16" height="16" style="fill: currentColor; margin-right: 8px;">
            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
          </svg>
          √öj profilk√©p v√°laszt√°sa
        </button>
        <p class="hint">PNG, JPG vagy JPEG form√°tum</p>
      </div>

      <!-- File Upload Section -->
      <div class="profile-section">
        <h4>F√°jlok felt√∂lt√©se</h4>
        <input type="file" id="fileInput" multiple style="display: none;" onchange="uploadFiles()" />
        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
          <svg viewBox="0 0 24 24" width="16" height="16" style="fill: currentColor; margin-right: 8px;">
            <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
          </svg>
          F√°jlok felt√∂lt√©se
        </button>
        <p class="hint">T√∂bb f√°jl kiv√°laszt√°sa egyszerre</p>
      </div>

      <!-- Uploaded Files List -->
      <div class="profile-section">
        <h4>Felt√∂lt√∂tt f√°jlok</h4>
        <div id="filesList" class="files-list">
          <div class="loading">Bet√∂lt√©s...</div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="document.getElementById('profileModal').classList.add('hidden')">Bez√°r√°s</button>
      </div>
    </div>
  </div>

  <script>
    let socket, token, myEmail, messages = [], activeUsers = [], myGroups = [];

    async function auth(type) {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      
      if (!email || !pass) {
        alert("K√©rlek t√∂ltsd ki mindk√©t mez≈ët!");
        return;
      }
      
      const res = await fetch(`http://localhost:3000/user/${type}`, {
        method: "POST", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: pass })
      });
      
      const data = await res.json();
      
      if (data.token) {
        token = data.token; 
        myEmail = email;
        
        document.getElementById("authScreen").classList.add("hidden");
        document.getElementById("chatScreen").classList.remove("hidden");
        document.getElementById("userName").innerText = email.split('@')[0];
        document.getElementById("userAvatar").innerText = email.charAt(0).toUpperCase();

        loadData();
        connectWs();
      } else {
        alert(data.error || "Hiba t√∂rt√©nt!");
      }
    }

    async function loadData() {
      const msgRes = await fetch("http://localhost:3000/messages", { 
        headers: { "x-access-token": token } 
      });
      messages = await msgRes.json();
      await loadGroups();
      render();
    }

    async function loadGroups() {
      const grpRes = await fetch("http://localhost:3000/groups", { 
        headers: { "x-access-token": token } 
      });
      myGroups = await grpRes.json();
      renderSelect();
    }

    function connectWs() {
      socket = new WebSocket(`ws://localhost:8080?token=${token}`);

      socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === "users") {
          activeUsers = data.users;
          renderSelect();
        }
        else if (data.type === "updateGroups") {
          loadGroups();
        }
        else {
          messages.push(data);
          render();
        }
      };
    }

    function renderSelect() {
      const sel = document.getElementById("targetSelect");
      const current = sel.value;
      
      sel.innerHTML = '<option value="">Publikus cseveg√©s</option>';
      
      if (myGroups.length > 0) {
        sel.innerHTML += '<optgroup label="Csoportok">';
        myGroups.forEach(g => sel.innerHTML += `<option value="GRP_${g.id}">${g.name}</option>`);
        sel.innerHTML += '</optgroup>';
      }
      
      const otherUsers = activeUsers.filter(u => u !== myEmail);
      if (otherUsers.length > 0) {
        sel.innerHTML += '<optgroup label="Priv√°t √ºzenetek">';
        otherUsers.forEach(u => sel.innerHTML += `<option value="${u}">${u.split('@')[0]}</option>`);
        sel.innerHTML += '</optgroup>';
      }
      
      sel.value = current;
    }

    function render() {
      const target = document.getElementById("targetSelect").value;
      const box = document.getElementById("messages");

      const filteredMessages = messages.filter(m => {
        if (target.startsWith("GRP_")) {
          const grpId = parseInt(target.split("_")[1]);
          return m.groupId === grpId;
        }

        if (target) {
          return !m.groupId && (
            (m.senderEmail === target && m.receiverEmail === myEmail) ||
            (m.senderEmail === myEmail && m.receiverEmail === target)
          );
        }

        return !m.groupId && !m.receiverEmail;
      });

      if (filteredMessages.length === 0) {
        box.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <span>M√©g nincsenek √ºzenetek</span>
          </div>
        `;
        return;
      }

      box.innerHTML = "";
      
      filteredMessages.forEach(m => {
        const isMe = m.senderEmail === myEmail;
        const senderName = isMe ? "Te" : m.senderEmail.split('@')[0];
        const msgClass = isMe ? "sent" : "received";

        box.innerHTML += `
          <div class="message ${msgClass}">
            <span class="message-sender">${senderName}</span>
            <div class="message-bubble">${escapeHtml(m.message)}</div>
          </div>
        `;
      });

      box.scrollTop = box.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function send() {
      const input = document.getElementById("msgInput");
      const msg = input.value.trim();
      const target = document.getElementById("targetSelect").value;
      
      if (!msg) return;

      let payload = { message: msg };
      if (target.startsWith("GRP_")) payload.groupId = parseInt(target.split("_")[1]);
      else if (target) payload.targetEmail = target;

      await fetch("http://localhost:3000/messages", {
        method: "POST", 
        headers: { "Content-Type": "application/json", "x-access-token": token },
        body: JSON.stringify(payload)
      });

      socket.send(JSON.stringify(payload));
      input.value = "";
    }

    function showGroupModal() {
      document.getElementById("groupModal").classList.remove("hidden");
      document.getElementById("newGroupName").value = "";
      
      const list = document.getElementById("userListCheckboxes");
      const otherUsers = activeUsers.filter(u => u !== myEmail);
      
      if (otherUsers.length === 0) {
        list.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">
            Nincs el√©rhet≈ë felhaszn√°l√≥
          </div>
        `;
        return;
      }
      
      list.innerHTML = "";
      otherUsers.forEach((u, i) => {
        list.innerHTML += `
          <div class="user-list-item">
            <input type="checkbox" id="user_${i}" value="${u}">
            <label for="user_${i}">${u.split('@')[0]}</label>
          </div>
        `;
      });
    }

    async function createGroup() {
      const name = document.getElementById("newGroupName").value.trim();
      const checks = document.querySelectorAll("#userListCheckboxes input:checked");
      const members = Array.from(checks).map(c => c.value);

      if (!name) {
        alert("Add meg a csoport nev√©t!");
        return;
      }

      if (members.length === 0) {
        alert("V√°lassz legal√°bb egy tagot!");
        return;
      }

      const res = await fetch("http://localhost:3000/groups", {
        method: "POST", 
        headers: { "Content-Type": "application/json", "x-access-token": token },
        body: JSON.stringify({ name, members })
      });

      if (res.ok) {
        document.getElementById("groupModal").classList.add("hidden");

        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "newGroup", members: members }));
        }

        loadGroups();
      } else {
        const err = await res.json();
        alert(err.error);
      }
    }

    // Profile Modal Functions
    async function showProfileModal() {
      document.getElementById("profileModal").classList.remove("hidden");
      
      // Set current avatar
      const avatarEl = document.getElementById("profileAvatar");
      const currentAvatar = document.getElementById("userAvatar");
      avatarEl.innerHTML = currentAvatar.innerHTML;
      
      // Load files list
      await loadFilesList();
    }

    async function loadFilesList() {
      const listEl = document.getElementById("filesList");
      
      try {
        const res = await fetch("http://localhost:3000/files", {
          headers: { "x-access-token": token }
        });
        
        if (!res.ok) {
          listEl.innerHTML = '<div class="empty-files">Nincsenek felt√∂lt√∂tt f√°jlok</div>';
          return;
        }
        
        const files = await res.json();
        
        if (files.length === 0) {
          listEl.innerHTML = '<div class="empty-files">Nincsenek felt√∂lt√∂tt f√°jlok</div>';
          return;
        }
        
        listEl.innerHTML = files.map(file => `
          <div class="file-item">
            <svg viewBox="0 0 24 24" width="20" height="20" style="fill: #666;">
              <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
            </svg>
            <span class="file-name">${escapeHtml(file.name)}</span>
            <a href="${file.url}" class="btn-download" download>
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
              </svg>
            </a>
          </div>
        `).join('');
        
      } catch (err) {
        console.error(err);
        listEl.innerHTML = '<div class="empty-files">Hiba t√∂rt√©nt a f√°jlok bet√∂lt√©sekor</div>';
      }
    }

    async function uploadAvatar() {
      const input = document.getElementById("avatarInput");
      const file = input.files[0];
      
      if (!file) return;
      
      // Check file type
      if (!['image/png', 'image/jpg', 'image/jpeg'].includes(file.type)) {
        alert("Csak PNG, JPG vagy JPEG form√°tum enged√©lyezett!");
        return;
      }
      
      // Check file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert("A f√°jl m√©rete nem lehet nagyobb 5MB-n√°l!");
        return;
      }
      
      const formData = new FormData();
      formData.append("avatar", file);
      
      try {
        const res = await fetch("http://localhost:3000/user/avatar", {
          method: "PUT",
          headers: { "x-access-token": token },
          body: formData
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert("Profilk√©p sikeresen felt√∂ltve!");
          
          // Update avatar display with first letter until we implement image display
          // In a real app, you'd update the avatar to show the actual image
          loadFilesList(); // Refresh files list
        } else {
          alert(data.error || "Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n!");
        }
      } catch (err) {
        console.error(err);
        alert("Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n!");
      }
      
      input.value = ""; // Reset input
    }

    async function uploadFiles() {
      const input = document.getElementById("fileInput");
      const files = input.files;
      
      if (!files || files.length === 0) return;
      
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
      }
      
      try {
        const res = await fetch("http://localhost:3000/files/upload", {
          method: "POST",
          headers: { "x-access-token": token },
          body: formData
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert(`${files.length} f√°jl sikeresen felt√∂ltve!`);
          await loadFilesList(); // Refresh files list
        } else {
          alert(data.error || "Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n!");
        }
      } catch (err) {
        console.error(err);
        alert("Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n!");
      }
      
      input.value = ""; // Reset input
    }
  </script>
</body>

</html>